name: Hugo Blog Deploy and Project Data Update

on:
  push:
    branches:
      - main

# Define two jobs: fetch_data (to get repo list) and deploy (to build and publish)
jobs:

  fetch_data:
    # This job fetches data from GitHub and pushes it back to the source branch
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit the updated projects.json file back to 'main'
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch GitHub Repos and Save to Data File
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.listForUser({
              username: 'sactyr',
              type: 'public',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });
            
            const projectsData = response.data.map(repo => ({
              name: repo.name,
              full_name: repo.full_name,
              html_url: repo.html_url,
              description: repo.description,
              language: repo.language,
              stargazers_count: repo.stargazers_count,
              forks_count: repo.forks_count,
              updated_at: repo.updated_at
            }));
            
            const fs = require('fs');
            fs.mkdirSync('data', { recursive: true });
            fs.writeFileSync('data/projects.json', JSON.stringify(projectsData, null, 2));

      - name: Commit and Push Updated Data File
        uses: EndBug/add-and-commit@v9
        with:
          add: 'data/projects.json'
          message: 'chore: Update projects data from GitHub API'
          committer_name: 'GitHub Actions Bot'
          committer_email: 'github-actions[bot]@users.noreply.github.com'
          default_author: github_actions
          
  deploy:
    # This job builds the site and pushes the output to the gh-pages branch
    needs: fetch_data # Ensure this job runs ONLY after the project data is updated
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      pages: write 
      id-token: write 

    env:
      HUGO_VERSION: 0.152.2 
      THEME_DIR: themes/blowfish

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Build Hugo Site
        run: hugo --minify

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages # The branch GitHub Pages serves from